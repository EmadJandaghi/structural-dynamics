function [Kt,fint]=MindlinPlateKtFint(nD,elConn,DOFConn,...
    refCoords,Dh,Nx,Ny,Nxy,activeDOFs,applyBC)
% MindlinPlateKtFint.m
% Calculates Global Stiffness Matrix & Internal load vector of Mindlin Plate
% This is a finite element analysis of the geometrically nonlinear
% behaviour of plates using a Mindlin formulation with the assumption of small rotations.
% Based On:----------------------------------------
% (1980) - A. Pica, R.D. Wood, E. Hinton - 
% Finite element analysis of geometrically nonlinear plate behaviour
% using a mindlin formulation
% -------------------------------------------------
% Here, 8 Node serendipity Element (QS) is employed

nel=length(elConn); %number of Elements
nDOFs=5*length(refCoords);  %number of Degrees of Freedom
D1=zeros(nDOFs,1);  % initial value of displacement vector
fint=zeros(nDOFs,1);    % initial value of internal force vector
Kt=sparse(nDOFs,nDOFs);    % initial value of Stiffness Matrix
%% Check nargin
if nargin<10
    applyBC=1;
end
%% nodal Displacement size Check (active or all)
if length(nD)~=nDOFs
    D1(activeDOFs)=nD;
else
    D1=nD;
end
%%  Finite Element Loop
for e=1:nel
   elID=elConn(e,:);
   DOFID=DOFConn(e,:);
   elCoords=refCoords(elID,[1,2]);
   eD=D1(DOFID);
   [kte,finte]=GetElementKtFint(elCoords,Dh,eD,Nx,Ny,Nxy);
   Kt(DOFID,DOFID)=Kt(DOFID,DOFID)+kte;
   fint(DOFID)=fint(DOFID)+finte; 
end
if applyBC==1
    Kt=Kt(activeDOFs,activeDOFs);
    fint=fint(activeDOFs);
end
end

function [kte,finte]=GetElementKtFint(elCoords,Dh,eD,Nx,Ny,Nxy)
wg=[2,0,0;1,1,0;5/9,8/9,5/9];
xg=[0,0,0;-(1/sqrt(3)),1/sqrt(3),0;-sqrt(3/5),0,sqrt(3/5)];
ngp = 2;
% Initializing
K0=zeros(40);
K1L=zeros(40);
K2L=zeros(40);
K3L=zeros(40);
Ksig=zeros(40);
finte= zeros(40,1);

for i=1:ngp
    wi=wg(ngp,i);
    xi=xg(ngp,i);
  for j=1:ngp
      wj=wg(ngp,j);
      eta=xg(ngp,j);
      NV=[-((-1+eta)*(-1+xi)*(1+eta+xi))/4,...
          ((-1+eta)*(-1+xi^2))/2,((-1+eta)*(1+eta-xi)*(1+xi))/4,...
          -((-1+eta^2)*(1+xi))/2,((1+eta)*(1+xi)*(-1+eta+xi))/4,...
          -((1+eta)*(-1+xi^2))/2,((1+eta)*(-1+xi)*(1-eta+xi))/4,...
          ((-1+eta^2)*(-1+xi))/2];
      dNVxi=[-((-1+eta)*(eta+2*xi))/4,(-1+eta)*xi,...
          ((-1+eta)*(eta-2*xi))/4,(1-eta^2)/2,((1+eta)*(eta+2*xi))/4,...
          (-1-eta)*xi,-((1+eta)*(eta-2*xi))/4,(-1+eta^2)/2];
      dNVeta=[-((-1+xi)*(2*eta+xi))/4,(-1+xi^2)/2,...
          ((2*eta-xi)*(1+xi))/4,-(eta*(1+xi)),((1+xi)*(2*eta+xi))/4,...
          (1-xi^2)/2,-((2*eta-xi)*(-1+xi))/4,eta*(-1+xi)];
      J=[dNVxi;dNVeta]*elCoords;
      dNxy=J\[dNVxi;dNVeta];
      B0=[dNxy(1,1),0,0,0,0,dNxy(1,2),0,0,0,0,dNxy(1,3),0,0,0,0,dNxy(1,4),...
          0,0,0,0,dNxy(1,5),0,0,0,0,dNxy(1,6),0,0,0,0,dNxy(1,7),0,0,0,0,...
          dNxy(1,8),0,0,0,0;0,dNxy(2,1),0,0,0,0,dNxy(2,2),0,0,0,0,...
          dNxy(2,3),0,0,0,0,dNxy(2,4),0,0,0,0,dNxy(2,5),0,0,0,0,dNxy(2,6),...
          0,0,0,0,dNxy(2,7),0,0,0,0,dNxy(2,8),0,0,0;dNxy(2,1),dNxy(1,1),0,...
          0,0,dNxy(2,2),dNxy(1,2),0,0,0,dNxy(2,3),dNxy(1,3),0,0,0,dNxy(2,4),...
          dNxy(1,4),0,0,0,dNxy(2,5),dNxy(1,5),0,0,0,dNxy(2,6),dNxy(1,6),0,...
          0,0,dNxy(2,7),dNxy(1,7),0,0,0,dNxy(2,8),dNxy(1,8),0,0,0;0,0,0,...
          -dNxy(1,1),0,0,0,0,-dNxy(1,2),0,0,0,0,-dNxy(1,3),0,0,0,0,...
          -dNxy(1,4),0,0,0,0,-dNxy(1,5),0,0,0,0,-dNxy(1,6),0,0,0,0,...
          -dNxy(1,7),0,0,0,0,-dNxy(1,8),0;0,0,0,0,-dNxy(2,1),0,0,0,0,...
          -dNxy(2,2),0,0,0,0,-dNxy(2,3),0,0,0,0,-dNxy(2,4),0,0,0,0,...
          -dNxy(2,5),0,0,0,0,-dNxy(2,6),0,0,0,0,-dNxy(2,7),0,0,0,0,...
          -dNxy(2,8);0,0,0,-dNxy(2,1),-dNxy(1,1),0,0,0,-dNxy(2,2),...
          -dNxy(1,2),0,0,0,-dNxy(2,3),-dNxy(1,3),0,0,0,-dNxy(2,4),...
          -dNxy(1,4),0,0,0,-dNxy(2,5),-dNxy(1,5),0,0,0,-dNxy(2,6),...
          -dNxy(1,6),0,0,0,-dNxy(2,7),-dNxy(1,7),0,0,0,-dNxy(2,8),...
          -dNxy(1,8);0,0,dNxy(1,1),-NV(1),0,0,0,dNxy(1,2),-NV(2),...
          0,0,0,dNxy(1,3),-NV(3),0,0,0,dNxy(1,4),-NV(4),0,0,0,...
          dNxy(1,5),-NV(5),0,0,0,dNxy(1,6),-NV(6),0,0,0,dNxy(1,7),...
          -NV(7),0,0,0,dNxy(1,8),-NV(8),0;0,0,dNxy(2,1),0,-NV(1),0,...
          0,dNxy(2,2),0,-NV(2),0,0,dNxy(2,3),0,-NV(3),0,0,dNxy(2,4),...
          0,-NV(4),0,0,dNxy(2,5),0,-NV(5),0,0,dNxy(2,6),0,-NV(6),0,0,...
          dNxy(2,7),0,-NV(7),0,0,dNxy(2,8),0,-NV(8)];
      GM=[0,0,dNxy(1,1),0,0,0,0,dNxy(1,2),0,0,0,0,dNxy(1,3),0,0,0,0,...
          dNxy(1,4),0,0,0,0,dNxy(1,5),0,0,0,0,dNxy(1,6),0,0,0,0,dNxy(1,7),...
          0,0,0,0,dNxy(1,8),0,0;0,0,dNxy(2,1),0,0,0,0,dNxy(2,2),0,0,0,0,...
          dNxy(2,3),0,0,0,0,dNxy(2,4),0,0,0,0,dNxy(2,5),0,0,0,0,dNxy(2,6),...
          0,0,0,0,dNxy(2,7),0,0,0,0,dNxy(2,8),0,0];
      ATheta=[dNxy(1,:)*eD(3:5:end),0;0,dNxy(2,:)*eD(3:5:end);...
          dNxy(2,:)*eD(3:5:end),dNxy(1,:)*eD(3:5:end)];
      BL=[0,0,ATheta(1,1)*dNxy(1,1)+ATheta(1,2)*dNxy(2,1),0,0,0,0,...
          ATheta(1,1)*dNxy(1,2)+ATheta(1,2)*dNxy(2,2),0,0,0,0,...
          ATheta(1,1)*dNxy(1,3)+ATheta(1,2)*dNxy(2,3),0,0,0,0,...
          ATheta(1,1)*dNxy(1,4)+ATheta(1,2)*dNxy(2,4),0,0,0,0,...
          ATheta(1,1)*dNxy(1,5)+ATheta(1,2)*dNxy(2,5),0,0,0,0,...
          ATheta(1,1)*dNxy(1,6)+ATheta(1,2)*dNxy(2,6),0,0,0,0,...
          ATheta(1,1)*dNxy(1,7)+ATheta(1,2)*dNxy(2,7),0,0,0,0,...
          ATheta(1,1)*dNxy(1,8)+ATheta(1,2)*dNxy(2,8),0,0;0,0,...
          ATheta(2,1)*dNxy(1,1)+ATheta(2,2)*dNxy(2,1),0,0,0,0,...
          ATheta(2,1)*dNxy(1,2)+ATheta(2,2)*dNxy(2,2),0,0,0,0,...
          ATheta(2,1)*dNxy(1,3)+ATheta(2,2)*dNxy(2,3),0,0,0,0,...
          ATheta(2,1)*dNxy(1,4)+ATheta(2,2)*dNxy(2,4),0,0,0,0,...
          ATheta(2,1)*dNxy(1,5)+ATheta(2,2)*dNxy(2,5),0,0,0,0,...
          ATheta(2,1)*dNxy(1,6)+ATheta(2,2)*dNxy(2,6),0,0,0,0,...
          ATheta(2,1)*dNxy(1,7)+ATheta(2,2)*dNxy(2,7),0,0,0,0,...
          ATheta(2,1)*dNxy(1,8)+ATheta(2,2)*dNxy(2,8),0,0;0,0,...
          ATheta(3,1)*dNxy(1,1)+ATheta(3,2)*dNxy(2,1),0,0,0,0,...
          ATheta(3,1)*dNxy(1,2)+ATheta(3,2)*dNxy(2,2),0,0,0,0,...
          ATheta(3,1)*dNxy(1,3)+ATheta(3,2)*dNxy(2,3),0,0,0,0,...
          ATheta(3,1)*dNxy(1,4)+ATheta(3,2)*dNxy(2,4),0,0,0,0,...
          ATheta(3,1)*dNxy(1,5)+ATheta(3,2)*dNxy(2,5),0,0,0,0,...
          ATheta(3,1)*dNxy(1,6)+ATheta(3,2)*dNxy(2,6),0,0,0,0,...
          ATheta(3,1)*dNxy(1,7)+ATheta(3,2)*dNxy(2,7),0,0,0,0,...
          ATheta(3,1)*dNxy(1,8)+ATheta(3,2)*dNxy(2,8),0,0;0,0,0,0,0,0,0,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...
          0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...
          0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,...
          0,0,0,0,0,0,0];
      K0=K0+wi*wj*det(J)*(transpose(B0)*Dh*B0);
      K1L=K1L+wi*wj*det(J)*(transpose(B0)*Dh*BL);
      K2L=K2L+wi*wj*det(J)*(transpose(BL)*Dh*B0);
      K3L=K3L+wi*wj*det(J)*(transpose(BL)*Dh*BL);
      Ksig=Ksig+wi*wj*det(J)*(transpose(GM)*...
       [Nx,Nxy;
        Nxy,Ny]*GM);
      finte=finte+wi*wj*det(J)*(transpose(B0+BL)*Dh*(B0+0.5*BL))*eD;
  end
end
kte=K0+(K1L+K2L+K3L)+Ksig;
end